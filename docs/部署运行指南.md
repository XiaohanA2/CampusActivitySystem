# 校园活动系统部署运行指南

## 系统架构概览

校园活动系统采用分层架构设计，包含以下8个程序集：

1. **CampusActivity.Shared** - 共享库（DTOs、常量）
2. **CampusActivity.Domain** - 领域层（实体模型）
3. **CampusActivity.Infrastructure** - 基础设施层（数据访问、仓储）
4. **CampusActivity.Application** - 应用层（业务逻辑、服务）
5. **CampusActivity.WebAPI** - Web API层（REST API）
6. **CampusActivity.BlazorWeb** - Blazor前端（用户界面）
7. **CampusActivity.NativeLib** - C++/CLI混合编程（推荐引擎）
8. **CampusActivity.Core** - C++原生库（数据分析）

## 环境要求

### 开发环境
- **操作系统**: Windows 10/11, Linux, macOS
- **.NET SDK**: 8.0
- **Visual Studio**: 2022 或 VS Code
- **MySQL**: 8.0 或更高版本
- **Redis**: 6.0 或更高版本

### C++ 编译环境
- **Windows**: Visual Studio 2022 with C++ workloade
- **Linux**: GCC 9+ 或 Clang 10+
- **CMake**: 3.20 或更高版本r

## 快速开始

### 1. 克隆项目并安装依赖

```bash
# 克隆项目
git clone <repository-url>
cd CampusActivitySystem

# 恢复 NuGet 包
dotnet restore

# 构建解决方案
dotnet build
```

### 2. 数据库配置

#### 启动 MySQL 服务
```bash
# Windows (如果使用 XAMPP)
xampp-control.exe

# Linux
sudo systemctl start mysql

# macOS
brew services start mysql
```

#### 创建数据库
```sql
CREATE DATABASE CampusActivityDB CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

#### 启动 Redis 服务
```bash
# Windows
redis-server.exe

# Linux/macOS
redis-server
```

### 3. 配置应用设置

#### WebAPI 配置 (`src/CampusActivity.WebAPI/appsettings.json`)
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=CampusActivityDB;User=root;Password=123456;CharSet=utf8mb4;",
    "Redis": "localhost:6379"
  },
  "JwtSettings": {
    "SecretKey": "CampusActivitySystemSecretKey2024ForJWTTokenGeneration",
    "Issuer": "CampusActivitySystem",
    "Audience": "CampusActivityUsers",
    "ExpirationHours": 24
  }
}
```

#### Blazor 配置 (`src/CampusActivity.BlazorWeb/appsettings.json`)
```json
{
  "ApiSettings": {
    "BaseUrl": "https://localhost:7000/"
  }
}
```

### 4. 构建 C++ 组件

#### 构建 C++ 原生库
```bash
cd src/CampusActivity.Core
mkdir build && cd build
cmake ..
make  # Linux/macOS
# 或在 Windows 上使用 Visual Studio 构建
```

#### 构建 C++/CLI 库
```bash
cd src/CampusActivity.NativeLib
# 使用 Visual Studio 构建 .vcxproj 项目
# 或使用 MSBuild
msbuild CampusActivity.NativeLib.vcxproj /p:Configuration=Release
```

### 5. 运行系统

#### 启动 Web API
```bash
cd src/CampusActivity.WebAPI
dotnet run --urls "https://localhost:7000;http://localhost:5000"
```

#### 启动 Blazor 前端
```bash
cd src/CampusActivity.BlazorWeb
dotnet run --urls "https://localhost:7001;http://localhost:5001"
```

## 详细部署步骤

### 1. 生产环境配置

#### 环境变量设置
```bash
export ASPNETCORE_ENVIRONMENT=Production
export ASPNETCORE_URLS="http://0.0.0.0:5000"
```

#### 数据库迁移
```bash
cd src/CampusActivity.Infrastructure
dotnet ef database update --startup-project ../CampusActivity.WebAPI
```

### 2. Docker 部署

#### 创建 Dockerfile (WebAPI)
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS base
WORKDIR /app
EXPOSE 80
EXPOSE 443

FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src
COPY ["src/CampusActivity.WebAPI/CampusActivity.WebAPI.csproj", "src/CampusActivity.WebAPI/"]
COPY ["src/CampusActivity.Application/CampusActivity.Application.csproj", "src/CampusActivity.Application/"]
COPY ["src/CampusActivity.Infrastructure/CampusActivity.Infrastructure.csproj", "src/CampusActivity.Infrastructure/"]
COPY ["src/CampusActivity.Domain/CampusActivity.Domain.csproj", "src/CampusActivity.Domain/"]
COPY ["src/CampusActivity.Shared/CampusActivity.Shared.csproj", "src/CampusActivity.Shared/"]

RUN dotnet restore "src/CampusActivity.WebAPI/CampusActivity.WebAPI.csproj"
COPY . .
WORKDIR "/src/src/CampusActivity.WebAPI"
RUN dotnet build "CampusActivity.WebAPI.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "CampusActivity.WebAPI.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "CampusActivity.WebAPI.dll"]
```

#### Docker Compose 配置
```yaml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: CampusActivityDB
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:6.2-alpine
    ports:
      - "6379:6379"

  webapi:
    build:
      context: .
      dockerfile: src/CampusActivity.WebAPI/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=mysql;Database=CampusActivityDB;User=root;Password=root123;
      - ConnectionStrings__Redis=redis:6379
    ports:
      - "5000:80"
    depends_on:
      - mysql
      - redis

  blazorweb:
    build:
      context: .
      dockerfile: src/CampusActivity.BlazorWeb/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ApiSettings__BaseUrl=http://webapi:80/
    ports:
      - "5001:80"
    depends_on:
      - webapi

volumes:
  mysql_data:
```

### 3. 使用 Docker 运行
```bash
docker-compose up -d
```

## 测试指南

### 1. 单元测试
```bash
# 运行所有测试
dotnet test

# 运行特定项目测试
dotnet test tests/CampusActivity.Application.Tests
```

### 2. API 测试

#### 使用默认管理员账号登录
```bash
curl -X POST "https://localhost:7000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'
```

#### 获取活动列表
```bash
curl -X GET "https://localhost:7000/api/activities" \
  -H "Authorization: Bearer <your-jwt-token>"
```

### 3. 性能测试

#### 使用 Apache Benchmark
```bash
# 测试登录接口
ab -n 1000 -c 10 -T 'application/json' -p login.json https://localhost:7000/api/auth/login

# 测试活动列表接口
ab -n 1000 -c 10 -H "Authorization: Bearer <token>" https://localhost:7000/api/activities
```

## 故障排除

### 常见问题及解决方案

1. **端口冲突**
   ```bash
   # 查看端口占用
   netstat -ano | findstr :7000
   # 或使用不同端口
   dotnet run --urls "https://localhost:8000"
   ```

2. **数据库连接失败**
   - 检查 MySQL 服务状态
   - 验证连接字符串
   - 确认数据库权限

3. **C++ 编译错误**
   - 确保安装了正确的 Visual Studio 工作负载
   - 检查 CMake 版本
   - 验证路径中没有中文字符

4. **前端无法连接 API**
   - 检查 CORS 配置
   - 验证 API 基础 URL
   - 确认防火墙设置

### 日志查看

#### 查看应用日志
```bash
# 开发环境
dotnet run --verbosity diagnostic

# 生产环境查看日志文件
tail -f logs/app.log
```

#### 查看 Docker 日志
```bash
docker-compose logs -f webapi
docker-compose logs -f blazorweb
```

## 监控与维护

### 1. 健康检查
```bash
# API 健康检查
curl https://localhost:7000/health

# 数据库连接检查
curl https://localhost:7000/health/db
```

### 2. 性能监控
- CPU 和内存使用率
- 数据库连接池状态
- Redis 内存使用情况
- API 响应时间

### 3. 定期维护
- 数据库备份
- 日志文件清理
- 依赖包更新
- 安全补丁应用

## 扩展配置

### 1. 负载均衡配置

使用 Nginx 作为反向代理：

```nginx
upstream webapi {
    server localhost:5000;
    server localhost:5001;
}

upstream blazorweb {
    server localhost:6000;
    server localhost:6001;
}

server {
    listen 80;
    
    location /api/ {
        proxy_pass http://webapi;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    location / {
        proxy_pass http://blazorweb;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 2. SSL 证书配置

```bash
# 使用 Let's Encrypt
certbot --nginx -d yourdomain.com

# 或使用自签名证书（开发环境）
dotnet dev-certs https --trust
```

## 总结

校园活动系统集成了现代 .NET 技术栈与原生 C++ 模块，实现了完整的分层架构。通过本指南，您可以：

1. 快速搭建开发环境
2. 理解系统架构和组件关系
3. 成功部署到生产环境
4. 处理常见的部署问题
5. 进行系统监控和维护

系统充分展示了 .NET 9 的新特性、Entity Framework Core 的强大功能、以及混合编程的实践应用，是一个完整的企业级应用示例。