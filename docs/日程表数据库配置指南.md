# 日程表数据库配置指南

## 概述

本文档介绍如何为校园活动管理系统配置日程表功能的数据库表结构和示例数据。

## 数据库表结构

### ScheduleItems 表

日程表是用户个人日程管理的核心表，支持个人计划、活动安排、提醒事项等多种类型的日程管理。

#### 表结构

```sql
CREATE TABLE ScheduleItems (
    Id INT AUTO_INCREMENT PRIMARY KEY COMMENT '日程项ID',
    UserId INT NOT NULL COMMENT '用户ID',
    Title VARCHAR(200) NOT NULL COMMENT '日程标题',
    Description VARCHAR(1000) NULL COMMENT '日程描述',
    Location VARCHAR(200) NULL COMMENT '地点',
    StartTime DATETIME NOT NULL COMMENT '开始时间',
    EndTime DATETIME NOT NULL COMMENT '结束时间',
    Type INT NOT NULL DEFAULT 1 COMMENT '日程类型：1-个人计划，2-活动安排，3-提醒事项，4-会议，5-学习，6-其他',
    Priority INT NOT NULL DEFAULT 2 COMMENT '优先级：1-低，2-中，3-高，4-紧急',
    Color VARCHAR(7) NULL COMMENT '颜色代码（如：#007bff）',
    IsCompleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否已完成',
    Note VARCHAR(500) NULL COMMENT '备注',
    ActivityId INT NULL COMMENT '关联的活动ID（如果是活动相关日程）',
    CreatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UpdatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    IsDeleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否删除'
);
```

#### 字段说明

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| Id | INT | 日程项ID | 主键，自增 |
| UserId | INT | 用户ID | 外键，关联Users表 |
| Title | VARCHAR(200) | 日程标题 | 必填，最大200字符 |
| Description | VARCHAR(1000) | 日程描述 | 可选，最大1000字符 |
| Location | VARCHAR(200) | 地点 | 可选，最大200字符 |
| StartTime | DATETIME | 开始时间 | 必填 |
| EndTime | DATETIME | 结束时间 | 必填，必须大于开始时间 |
| Type | INT | 日程类型 | 1-个人计划，2-活动安排，3-提醒事项，4-会议，5-学习，6-其他 |
| Priority | INT | 优先级 | 1-低，2-中，3-高，4-紧急 |
| Color | VARCHAR(7) | 颜色代码 | 可选，格式：#RRGGBB |
| IsCompleted | BOOLEAN | 是否已完成 | 默认FALSE |
| Note | VARCHAR(500) | 备注 | 可选，最大500字符 |
| ActivityId | INT | 关联活动ID | 可选，外键关联Activities表 |
| CreatedAt | DATETIME | 创建时间 | 自动设置 |
| UpdatedAt | DATETIME | 更新时间 | 自动更新 |
| IsDeleted | BOOLEAN | 是否删除 | 软删除标记 |

#### 索引设计

```sql
-- 单列索引
INDEX idx_user_id (UserId)
INDEX idx_start_time (StartTime)
INDEX idx_end_time (EndTime)
INDEX idx_type (Type)
INDEX idx_priority (Priority)
INDEX idx_is_completed (IsCompleted)
INDEX idx_activity_id (ActivityId)

-- 复合索引
INDEX idx_user_start_time (UserId, StartTime)
INDEX idx_user_type (UserId, Type)
INDEX idx_user_completed (UserId, IsCompleted)
```

#### 外键约束

```sql
-- 用户外键
CONSTRAINT fk_schedule_user FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE

-- 活动外键
CONSTRAINT fk_schedule_activity FOREIGN KEY (ActivityId) REFERENCES Activities(Id) ON DELETE SET NULL
```

#### 检查约束

```sql
-- 日程类型检查
CONSTRAINT chk_schedule_type CHECK (Type IN (1, 2, 3, 4, 5, 6))

-- 优先级检查
CONSTRAINT chk_schedule_priority CHECK (Priority IN (1, 2, 3, 4))

-- 时间检查
CONSTRAINT chk_schedule_time CHECK (EndTime > StartTime)

-- 颜色格式检查
CONSTRAINT chk_schedule_color CHECK (Color IS NULL OR Color REGEXP '^#[0-9A-Fa-f]{6}$')
```

## 安装步骤

### 1. 创建数据库表

执行 `ScheduleItems_Table.sql` 脚本创建日程表：

```bash
mysql -u username -p database_name < ScheduleItems_Table.sql
```

### 2. 插入示例数据

执行 `ScheduleData.sql` 脚本插入示例数据：

```bash
mysql -u username -p database_name < ScheduleData.sql
```

### 3. 验证安装

检查表是否创建成功：

```sql
SELECT COUNT(*) as TableExists 
FROM information_schema.tables 
WHERE table_schema = 'your_database_name' AND table_name = 'ScheduleItems';
```

检查数据是否插入成功：

```sql
SELECT COUNT(*) as DataCount 
FROM ScheduleItems WHERE IsDeleted = 0;
```

## 功能特性

### 1. 日程类型

- **个人计划 (1)**: 用户个人安排的计划
- **活动安排 (2)**: 与校园活动相关的日程
- **提醒事项 (3)**: 重要提醒和截止日期
- **会议 (4)**: 各种会议安排
- **学习 (5)**: 学习相关的日程
- **其他 (6)**: 其他类型的日程

### 2. 优先级管理

- **低 (1)**: 不紧急的事项
- **中 (2)**: 一般优先级
- **高 (3)**: 重要事项
- **紧急 (4)**: 需要立即处理的事项

### 3. 活动关联

日程表可以与校园活动系统集成，当用户报名活动时，系统会自动在日程表中创建对应的日程项。

### 4. 颜色标记

支持为不同类型的日程设置不同的颜色，便于在日历视图中区分。

## 数据库视图

### 1. ScheduleStatistics 视图

提供用户日程统计信息：

```sql
CREATE VIEW ScheduleStatistics AS
SELECT 
    UserId,
    COUNT(*) as TotalItems,
    SUM(CASE WHEN IsCompleted = 1 THEN 1 ELSE 0 END) as CompletedItems,
    SUM(CASE WHEN IsCompleted = 0 AND EndTime > NOW() THEN 1 ELSE 0 END) as PendingItems,
    SUM(CASE WHEN IsCompleted = 0 AND EndTime <= NOW() THEN 1 ELSE 0 END) as OverdueItems,
    ROUND(SUM(CASE WHEN IsCompleted = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as CompletionRate
FROM ScheduleItems 
WHERE IsDeleted = 0
GROUP BY UserId;
```

### 2. TodaySchedule 视图

显示今日日程：

```sql
CREATE VIEW TodaySchedule AS
SELECT 
    s.*,
    u.FullName as UserName,
    u.StudentId,
    u.Major
FROM ScheduleItems s
JOIN Users u ON s.UserId = u.Id
WHERE s.IsDeleted = 0 
  AND DATE(s.StartTime) = CURDATE()
ORDER BY s.StartTime;
```

### 3. UpcomingSchedule 视图

显示即将到期的日程：

```sql
CREATE VIEW UpcomingSchedule AS
SELECT 
    s.*,
    u.FullName as UserName,
    u.StudentId,
    u.Major
FROM ScheduleItems s
JOIN Users u ON s.UserId = u.Id
WHERE s.IsDeleted = 0 
  AND s.StartTime > NOW()
  AND s.StartTime <= DATE_ADD(NOW(), INTERVAL 7 DAY)
  AND s.IsCompleted = 0
ORDER BY s.StartTime;
```

## 存储过程

### 1. GetUserScheduleStatistics

获取用户日程统计信息：

```sql
CALL GetUserScheduleStatistics(user_id);
```

### 2. GetUserScheduleByDateRange

获取指定日期范围的日程：

```sql
CALL GetUserScheduleByDateRange(user_id, start_date, end_date);
```

### 3. MarkScheduleAsCompleted

标记日程为完成状态：

```sql
CALL MarkScheduleAsCompleted(schedule_id, user_id);
```

## 触发器

### 1. UpdateScheduleOnActivityChange

当活动信息更新时，自动同步更新相关日程：

```sql
CREATE TRIGGER UpdateScheduleOnActivityChange
AFTER UPDATE ON Activities
FOR EACH ROW
BEGIN
    IF OLD.StartTime != NEW.StartTime OR OLD.EndTime != NEW.EndTime OR OLD.Location != NEW.Location THEN
        UPDATE ScheduleItems 
        SET 
            StartTime = NEW.StartTime,
            EndTime = NEW.EndTime,
            Location = NEW.Location,
            UpdatedAt = NOW()
        WHERE ActivityId = NEW.Id AND IsDeleted = 0;
    END IF;
END;
```

### 2. CleanScheduleOnActivityDelete

当活动被删除时，自动清理相关日程：

```sql
CREATE TRIGGER CleanScheduleOnActivityDelete
AFTER UPDATE ON Activities
FOR EACH ROW
BEGIN
    IF OLD.IsDeleted = 0 AND NEW.IsDeleted = 1 THEN
        UPDATE ScheduleItems 
        SET IsDeleted = 1, UpdatedAt = NOW()
        WHERE ActivityId = NEW.Id;
    END IF;
END;
```

## 示例数据

系统提供了丰富的示例数据，包括：

- 学习相关的日程（复习、作业、实验等）
- 个人计划（健身、创作、志愿服务等）
- 会议安排（项目会议、团队讨论等）
- 提醒事项（作业截止日期等）
- 活动相关的日程（自动从活动报名生成）

## 常见问题

### 1. 表创建失败

- 检查数据库权限
- 确认外键引用的表已存在
- 检查SQL语法是否正确

### 2. 数据插入失败

- 确认用户ID存在
- 检查时间格式是否正确
- 验证外键约束

### 3. 性能问题

- 确保索引已正确创建
- 检查查询是否使用了合适的索引
- 考虑分页查询大量数据

### 4. 数据一致性问题

- 检查触发器是否正常工作
- 确认外键约束设置正确
- 验证软删除逻辑

## 维护建议

### 1. 定期备份

```sql
-- 备份日程表数据
mysqldump -u username -p database_name ScheduleItems > schedule_backup.sql
```

### 2. 数据清理

```sql
-- 清理已删除的日程项（可选）
DELETE FROM ScheduleItems WHERE IsDeleted = 1 AND UpdatedAt < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

### 3. 性能监控

```sql
-- 检查索引使用情况
SHOW INDEX FROM ScheduleItems;

-- 分析查询性能
EXPLAIN SELECT * FROM ScheduleItems WHERE UserId = 1 AND StartTime >= '2024-01-01';
```

## 联系支持

如果在配置过程中遇到问题，请检查：

1. 数据库连接信息是否正确
2. 用户权限是否足够
3. 相关表是否已创建
4. 外键约束是否正确设置

更多技术支持请联系系统管理员。 