# 校园活动系统数据库配置指南

## 数据库环境要求

### MySQL 配置要求
- MySQL 8.0 或更高版本
- 支持 UTF8MB4 字符集
- InnoDB 存储引擎

### Redis 配置要求
- Redis 6.0 或更高版本
- 支持持久化配置

## 数据库连接字符串配置

### 1. MySQL 连接配置

在 `appsettings.json` 中配置：

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=CampusActivityDB;User=root;Password=your_password;CharSet=utf8mb4;"
  }
}
```

### 2. Redis 连接配置

```json
{
  "ConnectionStrings": {
    "Redis": "localhost:6379"
  }
}
```

## 数据库初始化脚本

### 1. 创建数据库

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS CampusActivityDB 
CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE CampusActivityDB;

-- 创建用户（可选）
CREATE USER IF NOT EXISTS 'campus_user'@'localhost' IDENTIFIED BY 'campus_password_2024';
GRANT ALL PRIVILEGES ON CampusActivityDB.* TO 'campus_user'@'localhost';
FLUSH PRIVILEGES;
```

### 2. 数据表结构

系统使用 Entity Framework Core Code First 模式，表结构会在首次运行时自动创建。

主要数据表包括：

- **Users** - 用户表
- **ActivityCategories** - 活动分类表
- **Activities** - 活动表
- **ActivityRegistrations** - 活动报名表
- **ActivityTags** - 活动标签表
- **UserActivityPreferences** - 用户活动偏好表

### 3. 种子数据

系统会在首次启动时自动插入以下种子数据：

#### 活动分类
- 学术讲座
- 文艺演出
- 体育竞技
- 社会实践
- 创新创业
- 交流参观

#### 默认管理员账户
- 用户名：admin
- 密码：admin123
- 角色：系统管理员

## EF Core 迁移命令

### 1. 安装 EF Core 工具

```bash
dotnet tool install --global dotnet-ef
```

### 2. 创建迁移

```bash
cd src/CampusActivity.Infrastructure
dotnet ef migrations add InitialCreate --startup-project ../CampusActivity.WebAPI
```

### 3. 更新数据库

```bash
dotnet ef database update --startup-project ../CampusActivity.WebAPI
```

### 4. 删除数据库（重置）

```bash
dotnet ef database drop --startup-project ../CampusActivity.WebAPI
```

## 数据库备份与恢复

### 1. 备份数据库

```bash
mysqldump -u root -p CampusActivityDB > campus_activity_backup.sql
```

### 2. 恢复数据库

```bash
mysql -u root -p CampusActivityDB < campus_activity_backup.sql
```

## 性能优化建议

### 1. 索引优化

```sql
-- 活动查询优化索引
CREATE INDEX idx_activities_status_start_time ON Activities(Status, StartTime);
CREATE INDEX idx_activities_category_status ON Activities(CategoryId, Status);

-- 用户查询优化索引
CREATE INDEX idx_users_username ON Users(Username);
CREATE INDEX idx_users_email ON Users(Email);

-- 报名查询优化索引
CREATE INDEX idx_registrations_user_activity ON ActivityRegistrations(UserId, ActivityId);
CREATE INDEX idx_registrations_activity_status ON ActivityRegistrations(ActivityId, Status);
```

### 2. 连接池配置

在连接字符串中添加连接池配置：

```
Server=localhost;Database=CampusActivityDB;User=campus_user;Password=campus_password_2024;
CharSet=utf8mb4;pooling=true;MinPoolSize=5;MaxPoolSize=100;ConnectionLifeTime=300;
```

### 3. Redis 配置优化

在 `redis.conf` 中添加：

```conf
# 内存配置
maxmemory 256mb
maxmemory-policy allkeys-lru

# 持久化配置
save 900 1
save 300 10
save 60 10000

# 网络配置
timeout 300
tcp-keepalive 60
```

## 监控与维护

### 1. 数据库性能监控

```sql
-- 查看慢查询
SHOW PROCESSLIST;

-- 查看表大小
SELECT 
    table_name AS "Table",
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS "Size (MB)"
FROM information_schema.tables 
WHERE table_schema = "CampusActivityDB"
ORDER BY (data_length + index_length) DESC;
```

### 2. 定期维护任务

```sql
-- 优化表
OPTIMIZE TABLE Activities, Users, ActivityRegistrations;

-- 分析表
ANALYZE TABLE Activities, Users, ActivityRegistrations;
```

## 故障排除

### 常见问题及解决方案

1. **连接超时**
   - 检查 MySQL 服务状态
   - 验证连接字符串
   - 检查防火墙设置

2. **字符编码问题**
   - 确保数据库字符集为 utf8mb4
   - 检查连接字符串中的 CharSet 参数

3. **Redis 连接失败**
   - 检查 Redis 服务状态
   - 验证 Redis 配置文件
   - 确认端口号和访问权限

4. **迁移失败**
   - 删除 Migrations 文件夹重新生成
   - 检查数据库权限
   - 查看详细错误日志

## 安全配置

### 1. 数据库安全

```sql
-- 删除默认账户
DROP USER IF EXISTS ''@'localhost';
DROP USER IF EXISTS ''@'%';

-- 设置安全密码策略
SET GLOBAL validate_password.policy = MEDIUM;
SET GLOBAL validate_password.length = 8;
```

### 2. 网络安全

- 使用 SSL 连接
- 限制数据库访问 IP
- 定期更新密码
- 启用审计日志

```sql
-- 启用 SSL
SHOW VARIABLES LIKE 'have_ssl';

-- 强制 SSL 连接
ALTER USER 'campus_user'@'localhost' REQUIRE SSL;
```